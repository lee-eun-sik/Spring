<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê³µì§€ì‚¬í•­ ëª©ë¡</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/tinymce/tinymce.min.js?ver=1.0.1"></script>
    <script th:src="@{/js/tinymce/tinymce.min.js?ver=1.0.1}"></script>
    <style>
        body { background-color: #f4f4f4; font-family: Arial; padding: 30px; }
        .btn {
            background-color: #222; color: white;
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>ê³µì§€ì‚¬í•­ ëª©ë¡</h2>
    <div id="notice-list"></div>

    <!-- Form to create new notice -->
    <h3>ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</h3>
    <form id="notice-form">
        <label for="title">ì œëª©</label>
        <input type="text" id="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" /><br><br>

        <label for="content">ë‚´ìš©</label>
        <textarea id="content"></textarea><br><br>

        <label>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</label>
        <div id="drop-zone" class="drop-zone">
            ì´ê³³ì— íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”.
            <input type="file" id="files" multiple hidden />
        </div>
        <div id="file-list">ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div><br><br>

        <button type="button" class="btn" id="submit-btn">ê³µì§€ì‚¬í•­ ì‘ì„±</button>
    </form>

    <script>
        tinymce.init({
            selector: '#content',
            height: 300,
            menubar: false,
            plugins: 'link image code lists',
            toolbar: 'undo redo | styleselect |fontselect fontsizeselect | bold italic | alignleft aligncenter alignright | bullist numlist | link image',
			fontsize_formats: '8pt 10pt 12pt 14pt'
        });

        $(document).ready(function() {
            // Load notices on page load
            loadNotices();

            // Function to load all notices via AJAX
            function loadNotices() {
                $.ajax({
                    url: '[[${apiBaseUrl}]]/api/newboard/notice.do',
                    type: 'POST',
                    success: function(data) {
                        var html = '';
                        data.forEach(function(notice) {
                            html += '<div><h4>' + notice.title + '</h4><p>' + notice.content + '</p></div>';
                        });
                        $('#notice-list').html(html);
                    }
                });
            }

            // Handle file uploads
            const dropZone = $('#drop-zone');
            const fileInput = $('#files');
            const fileList = $('#file-list');
            let selectedFiles = [];

			dropZone.on('click', (e) => {
			    e.stopPropagation();
			    fileInput.click();
			});

            dropZone.on('dragover', function(e) {
                e.preventDefault();
                dropZone.addClass('dragover');
            });

            dropZone.on('dragleave', function() {
                dropZone.removeClass('dragover');
            });

            dropZone.on('drop', function(e) {
                e.preventDefault();
                dropZone.removeClass('dragover');
                const files = Array.from(e.originalEvent.dataTransfer.files);
                selectedFiles = files;
                showFileNames(files);
            });

            fileInput.on('change', function() {
                selectedFiles = Array.from(fileInput[0].files);
                showFileNames(selectedFiles);
            });

            function showFileNames(files) {
                fileList.empty();
                files.forEach(function(file) {
                    fileList.append('<div>' + file.name + '</div>');
                });
            }

            // Handle submitting the new notice
            $('#submit-btn').on('click', function(e) {
                e.preventDefault();
				const formData = new FormData();
				const token = localStorage.getItem('token');
				formData.append("title", $('#title').val());
				formData.append("content", tinymce.get('content').getContent());
				selectedFiles.forEach(file => formData.append("files", file));

				$.ajax({
				    url: '[[${apiBaseUrl}]]/api/newboard/notice.do',
				    type: 'POST',
					headers: {
					        'Authorization': 'Bearer ' + token // Add the JWT token to the request headers
					    },
				    data: formData,
				    processData: false,
				    contentType: false, // âš ï¸ ë°˜ë“œì‹œ false
				    success: function(response) {
				        alert("ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
				        loadNotices();
				    },
				    error: function() {
				        alert("ê³µì§€ì‚¬í•­ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				    }
				});
            });
        });
    </script>
</body>
</html>